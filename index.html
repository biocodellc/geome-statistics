<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Configuration Statistics</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>

<div class="container">
    <h2>Approved Configurations</h2>
    <div class="accordion" id="approvedConfigs"></div>

    <h2>Non-Approved Configurations</h2>
    <div class="accordion" id="nonApprovedConfigs"></div>

    <h2>Configuration Count Comparison</h2>
    <canvas id="configChart"></canvas>
</div>

<script>
    $(document).ready(function () {
        // Function to load and parse CSV data
        function loadCSVData() {
            Papa.parse("statistics.csv", {
                download: true,
                header: true,
                complete: function (results) {
                    const data = results.data;
                    const approvedData = {};
                    const nonApprovedData = {};
                    const approvedProjects = {};
                    const nonApprovedProjects = {};

                    // Process each row in the CSV file
                    data.forEach(row => {
                        const isApproved = row.configNetworkApproved === "TRUE";
                        const configName = row.configName;
                        const projectDetails = {
                            projectId: row.projectId,
                            projectTitle: row.projectTitle,
                            principalInvestigator: row.principalInvestigator || "N/A",
                            EventCount: +row.EventCount || 0,
                            SampleCount: +row.SampleCount || 0
                        };

                        // Aggregate data based on approval status
                        if (isApproved) {
                            approvedData[configName] = approvedData[configName] || {
                                EventCount: 0,
                                SampleCount: 0
                            };
                            approvedData[configName].EventCount += projectDetails.EventCount;
                            approvedData[configName].SampleCount += projectDetails.SampleCount;

                            approvedProjects[configName] = approvedProjects[configName] || [];
                            approvedProjects[configName].push(projectDetails);
                        } else {
                            nonApprovedData[configName] = nonApprovedData[configName] || {
                                EventCount: 0,
                                SampleCount: 0
                            };
                            nonApprovedData[configName].EventCount += projectDetails.EventCount;
                            nonApprovedData[configName].SampleCount += projectDetails.SampleCount;

                            nonApprovedProjects[configName] = nonApprovedProjects[configName] || [];
                            nonApprovedProjects[configName].push(projectDetails);
                        }
                    });

                    // Create collapsible lists for approved and non-approved configurations
                    createCollapsibleList('approvedConfigs', approvedProjects);
                    createCollapsibleList('nonApprovedConfigs', nonApprovedProjects);

                    // Create comparison chart
                    createChart(approvedData, nonApprovedData);
                }
            });
        }

        // Helper function to create collapsible list
        function createCollapsibleList(containerId, projectsData) {
            Object.keys(projectsData).forEach(configName => {
                const projects = projectsData[configName];
                const projectList = projects.map(project => `
                    <li>
                        <strong>${project.projectTitle}</strong> (ID: ${project.projectId})<br>
                        PI: ${project.principalInvestigator}<br>
                        Event Count: ${project.EventCount}, Sample Count: ${project.SampleCount}
                    </li>
                `).join('');

                const content = `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#${configName.replace(/\s+/g, '')}Collapse">
                                ${configName}
                            </button>
                        </h2>
                        <div id="${configName.replace(/\s+/g, '')}Collapse" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <ul>${projectList}</ul>
                            </div>
                        </div>
                    </div>
                `;
                $(`#${containerId}`).append(content);
            });
        }

        // Helper function to create comparison chart
        function createChart(approvedData, nonApprovedData) {
            const labels = ["EventCount", "SampleCount"];
            const approvedCounts = labels.map(label => {
                return Object.values(approvedData).reduce((sum, data) => sum + data[label], 0);
            });
            const nonApprovedCounts = labels.map(label => {
                return Object.values(nonApprovedData).reduce((sum, data) => sum + data[label], 0);
            });

            const ctx = document.getElementById('configChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Approved',
                            data: approvedCounts,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Non-Approved',
                            data: nonApprovedCounts,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load and process the CSV data
        loadCSVData();
    });
</script>

</body>
</html>
